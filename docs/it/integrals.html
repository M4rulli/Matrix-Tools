<!DOCTYPE html>
<html lang="it" data-page-title="Integrali Indefiniti">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Integrali Indefiniti - Matrix Tools</title>
  <link rel="icon" href="../assets/icons/favicon.ico" sizes="any" />
  <link rel="icon" type="image/svg+xml" href="../assets/icons/favicon.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/icons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="../assets/icons/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/icons/apple-touch-icon.png" />
  <link rel="manifest" href="../assets/icons/site.webmanifest" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive-static.css" />
  <link href="../css/style.css" rel="stylesheet" />
  <link href="../css/panels-theme.css" rel="stylesheet" />
  
</head>
<body>
  <div id="navbar"></div>

  <div class="container-fluid" style="margin-top: 100px; padding: 0rem 1.5rem 0rem 0rem !important;">
    <style>
  .math-input   { font-size: 22px; display: inline-block; margin: 0 auto; }
  .step-title   { margin-top: 1em; }
  .centered-math{ text-align: center; }
  .rotate-icon  { transition: transform 0.3s ease; }
</style>

<div class="row">
  <!-- ────────────────────────────── CARD • INPUT ────────────────────────────── -->
  <div class="col-12 mb-4">
    <div class="card calculator-card shadow-sm">
      <div class="card-header bg-primary text-white d-flex align-items-center gap-2">
        <h5 class="card-title mb-0"><i class="fas fa-edit me-2"></i>Input</h5>
      </div>
      <div class="card-body">
        <!-- Toggle description -------------------------------------------------- -->
        <div class="mb-3">
          <button id="toggleDescrizione"
                  class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
                  type="button" data-bs-toggle="collapse"
                  data-bs-target="#descrizioneIntegrale"
                  aria-expanded="false" aria-controls="descrizioneIntegrale">
            <i id="descrizioneIcon" class="fas fa-chevron-down rotate-icon"></i>
            <span id="descrizioneText">Mostra descrizione</span>
          </button>
        </div>

        <!-- Description formale ------------------------------------------------- -->
        <div id="descrizioneIntegrale" class="collapse mb-3">
          <div class="card card-body bg-light border mt-2">
            <p class="text-muted mb-0">
              Dato un integrando \( f(x) \), questo strumento calcola una primitiva
              \( F(x) \) mostrando i passaggi tipici
              (linearità, sostituzioni, fratti semplici, integrazione per parti, …).<br>
              Inserisci l’integrando in notazione LaTeX: <code>\sin</code>,
              <code>\cos</code>, <code>\exp</code>, <code>\sqrt{ }</code>, …
              Le potenze si indicano con <code>^</code> oppure <code>**</code>.
            </p>
          </div>
        </div>

        <!-- MathLive field ------------------------------------------------------ -->
        <div class="mb-3">
          <label for="intField" class="form-label">Integrale indefinito:</label>
          <math-field id="intField"
                      delete-mode="off"
                      default-mode="math"
                      read-only="partial"
                      class="math-input"
                      style="width:100%;">
            \displaystyle \int \placeholder[integrand]{}\, dx
          </math-field>
        </div>

        <div class="form-text mb-3" style="font-size:0.85rem;">
          Completa il placeholder con l’integrando. Digita <code>\</code> per
          i comandi LaTeX rapidi.
        </div>

        <div class="text-center mt-3">
          <button id="calcButton"
                  onclick="calcolaIntegrale()"
                  class="btn btn-primary btn-sm px-3">
            <span id="calcButtonIcon"><i class="fas fa-play me-2"></i></span>
            Calcola Integrale
          </button>
          <button onclick="resetIntegrale()"
                  class="btn btn-secondary btn-sm px-3 ms-1">
            <i class="fas fa-eraser me-2"></i>Pulisci
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ────────────────────────────── CARD • OUTPUT ───────────────────────────── -->
  <div class="col-12">
    <div class="card output-card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0"><i class="fas fa-stream me-2"></i>Passaggi</h5>
      </div>
      <div class="card-body" id="output">
        <div class="empty-state text-center text-muted py-5">
          <i class="fas fa-project-diagram fa-3x mb-3 opacity-50"></i>
          <h6>Pronto</h6>
          <p class="small">Inserisci un integrando e premi “Calcola Integrale”.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ────────────────────────────────── SCRIPT ────────────────────────────────── -->
<script>
/* ------------------------- Function principale ---------------------------- */
function calcolaIntegrale () {
  window.__scrollAfterResult = true;
  const buttonIcon = document.getElementById('calcButtonIcon');
  const output     = document.getElementById('output');
  const integrand  = window.intField.getPromptValue('integrand')?.trim();

  if (!integrand) {
    output.innerHTML = createErrorAlert("Inserisci un integrando.");
    MathJax.typesetPromise([output]);
    return;
  }

  /* spinner */ 
  buttonIcon.innerHTML =
    '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>';

  output.innerHTML =
    '<div class="text-center my-3">' +
      '<div class="spinner-border text-primary" role="status">' +
        '<span class="visually-hidden">Calcolo…</span>' +
      '</div>' +
    '</div>';

  fetch('/api/integral', {
    method : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body   : JSON.stringify({ integrand })
  })
  .then(r => r.json())
  .then(res => {
    console.log(res);               // log step details to the console
    if (!res.success) {
      output.innerHTML = createErrorAlert(res.error);
    } else {
      /* Build HTML with gli step LaTeX */
      const stepHtml = res.steps.map((step, i) =>
        `<p class="step-title"><b>${i + 1})</b> ${step.title}</p>
         <div class="centered-math">\\[${step.content}\\]</div>`).join('');

      output.innerHTML  = `<div class="result-section">${stepHtml}</div>`;
      output.dataset.latex = stepHtml;

      /* bottone “salva nel notebook” */
      const payload = {
        algorithm   : 'Integrale indefinito',
        input       : integrand,
        htmlOutput  : output.innerHTML,
        output      : stepHtml,
        outputLatex : stepHtml,
        rawData     : res
      };
      window.currentExercise = payload;
      injectSaveButton(output.querySelector('.result-section'), payload);

      MathJax.typesetPromise([output]).then(scrollToOutput);
    }
  })
  .catch(err => {
    output.innerHTML = createErrorAlert(err.message);
    MathJax.typesetPromise([output]).then(scrollToOutput);
  })
  .finally(() => {
    buttonIcon.innerHTML = '<i class="fas fa-play me-2"></i>';
  });
}

/* ------------------------- Function reset --------------------------------- */
function resetIntegrale () {
  window.intField.setValue('\\displaystyle \\int \\\\placeholder[integrand]{}\\, dx');
  document.getElementById('output').innerHTML =
    '<div class="empty-state text-center text-muted py-5">' +
      '<i class="fas fa-project-diagram fa-3x mb-3 opacity-50"></i>' +
      '<h6>Pronto</h6>' +
      '<p class="small">Inserisci un integrando e premi “Calcola Integrale”.</p>' +
    '</div>';
}

/* --------------------- Utilità: alert di error --------------------------- */
function createErrorAlert (msg) {
  return (
    '<div class="alert alert-danger">' +
      '<i class="fas fa-exclamation-triangle me-2"></i>' +
      '<strong>Errore.</strong> ' + msg +
    '</div>'
  );
}

/* ------------------ Description toggle handling --------------------------- */

document.addEventListener('DOMContentLoaded', () => {
  window.intField = document.getElementById('intField');

  const descrCollapse = document.getElementById('descrizioneIntegrale');
  const descrText     = document.getElementById('descrizioneText');
  const descrIcon     = document.getElementById('descrizioneIcon');

  descrCollapse.addEventListener('hide.bs.collapse', () => {
    descrText.textContent = 'Mostra descrizione';
    descrIcon.classList.remove('fa-chevron-up');
    descrIcon.classList.add   ('fa-chevron-down');
  });
  descrCollapse.addEventListener('show.bs.collapse', () => {
    descrText.textContent = 'Nascondi descrizione';
    descrIcon.classList.remove('fa-chevron-down');
    descrIcon.classList.add   ('fa-chevron-up');
  });
});

/* ----------------------- Scroll dopo il risultato ------------------------- */
function scrollToOutput () {
  if (window.__scrollAfterResult) {
    document.querySelector('.output-card')
            .scrollIntoView({ behavior: 'smooth' });
    window.__scrollAfterResult = false;
  }
}
</script>

<script src="../js/anti-autoscroll.js"></script>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/mathlive@0.92.0/dist/mathlive.min.js"></script>
  <script src="../js/layout-state.js"></script>
  <script src="../js/site-i18n.js"></script>
  <script src="../js/math-render-cache.js"></script>
  <script src="../js/component-loader.js"></script>
</body>
</html>
