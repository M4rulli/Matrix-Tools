<!DOCTYPE html>
<html lang="it" data-page-title="Studio di Funzione">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Studio di Funzione - Matrix Tools</title>
  <link rel="icon" href="../assets/icons/favicon.ico" sizes="any" />
  <link rel="icon" type="image/svg+xml" href="../assets/icons/favicon.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/icons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="../assets/icons/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/icons/apple-touch-icon.png" />
  <link rel="manifest" href="../assets/icons/site.webmanifest" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive-static.css" />
  <link href="../css/style.css" rel="stylesheet" />
  <link href="../css/panels-theme.css" rel="stylesheet" />
  
</head>
<body>
  <div id="navbar"></div>

  <div class="container-fluid" style="margin-top: 100px; padding: 0rem 1.5rem 0rem 0rem !important;">
    <style>
  .math-input { font-size: 22px; display: inline-block; margin: 0 auto; }
  .step-title { margin-top: 1em; }
  .centered-math { text-align: center; }
  .rotate-icon { transition: transform 0.3s ease; }
</style>

<div class="row">
  <!-- INPUT CARD -------------------------------------------------------------------------->
  <div class="col-12 mb-4">
    <div class="card calculator-card shadow-sm">
      <div class="card-header bg-primary text-white d-flex align-items-center gap-2">
        <h5 class="card-title mb-0"><i class="fas fa-edit me-2"></i>Input</h5>
      </div>
      <div class="card-body">
        <!-- Toggle description -->
        <div class="mb-3">
          <button id="toggleDescrizione" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
                  type="button" data-bs-toggle="collapse" data-bs-target="#descrizioneStudioFunzione"
                  aria-expanded="false" aria-controls="descrizioneStudioFunzione">
            <i id="descrizioneIcon" class="fas fa-chevron-down rotate-icon transition"></i>
            <span id="descrizioneText">Mostra descrizione</span>
          </button>
        </div>

        <!-- Formal Description -->
        <div id="descrizioneStudioFunzione" class="collapse mb-3">
          <div class="card card-body bg-light border mt-2">
            <p class="text-muted">
              Lo <strong>studio di una funzione reale di variabile reale</strong> consiste nell’analizzare in modo sistematico il comportamento della funzione \( f\colon \mathbb{R} \to \mathbb{R} \), a partire dalla sua espressione analitica. Gli aspetti tipicamente indagati includono il <em>dominio di definizione</em>, la <em>parità</em> (simmetria rispetto all’origine o all’asse delle ordinate), l’<em>eventuale periodicità</em>, i <em>punti di intersezione con gli assi cartesiani</em>, e la <em>continuità</em> della funzione.<br>
              Vengono inoltre analizzati i <em>limiti notevoli</em> (in particolare agli estremi del dominio e nei punti di discontinuità), la <em>derivabilità</em> e il <em>segno della derivata prima</em> per studiare gli <em>intervalli di monotonia</em> e individuare eventuali <em>estremi relativi</em>.<br>
            </p>
          </div>
        </div>

        <!-- MathLive expression -->
        <div class="mb-3">
          <label for="exprField" class="form-label">Espressione:</label>
          <math-field id="exprField"
                      delete-mode="off"
                      default-mode="math"
                      read-only="partial"
                      class="math-input"
                      style="width:100%;">
            f(x)=\placeholder[expr]{}
          </math-field>
        </div>

        <div class="form-text mb-3" style="font-size:0.85rem;">
          <p style="text-align: justify;">
            Tutte le funzioni devono essere scritte esplicitando l’argomento tra parentesi tonde. Ad esempio,
            <code>sin(x)</code>, <code>log(x+1)</code>, <code>tan(2x)</code>. La mancata chiusura può generare errori. L’algoritmo esegue uno studio completo della funzione, ma <strong> al momento non effettua l’analisi della derivata seconda </strong>.              Per digitare radici diverse dalla radice quadrata, è preferibile utilizzare la notazione esponenziale, ad esempio
            <code>x^(1/3)</code> per la radice cubica, <code>x^(1/4)</code> per la radice quarta, e così via. La funzione <code>sqrt</code>
            è invece sufficiente per indicare la sola radice quadrata.
          </p>
          <p>
             Un report sulle funzioni testate è disponibile <a href="https://drive.google.com/file/d/1pTi-uGyW6hANfn1xBc7kwHAoC6nBy1ZP/view" target="_blank" rel="noopener noreferrer">qui</a>.
          </p>
        </div>

        <div class="text-center mt-3">
          <button id="analyzeButton" onclick="analizzaFunzione()" class="btn btn-primary btn-sm px-3">
            <span id="analyzeButtonIcon"><i class="fas fa-play me-2"></i></span>
            Analizza Funzione
          </button>
          <button onclick="resetStudio()" class="btn btn-secondary btn-sm px-3 ms-1">
            <i class="fas fa-eraser me-2"></i>Pulisci
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- OUTPUT CARD ------------------------------------------------------------------------->
  <div class="col-12">
    <div class="card output-card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Output</h5>
      </div>
      <div class="card-body" id="output">
        <div class="empty-state text-center text-muted py-5">
          <i class="fas fa-project-diagram fa-3x mb-3 opacity-50"></i>
          <h6>Pronto</h6>
          <p class="small">Inserisci un’espressione e premi “Analizza Funzione”.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPT ---------------------------------------------------------------------------------->
<script>
function analizzaFunzione() {
  window.__scrollAfterResult = true;
  const buttonIcon = document.getElementById("analyzeButtonIcon");
  const output = document.getElementById('output');
  const expr = window.exprField.getPromptValue("expr")?.trim();

  if (!expr) {
    output.innerHTML = createErrorAlert("Inserisci un'espressione.");
    MathJax.typesetPromise([output]);
    return;
  }

  // Loading spinner
  buttonIcon.innerHTML = 
    '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>';

  output.innerHTML = 
    '<div class="text-center my-3">' +
      '<div class="spinner-border text-primary" role="status">' +
        '<span class="visually-hidden">Calcolo...</span>' +
      '</div>' +
    '</div>';

  fetch((window.API_BASE || '') + '/api/function-study', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ expr })
  })
  .then(r => r.json())
  .then(res => {
    if (!res.success) {
      output.innerHTML = createErrorAlert(res.error);
    } else {
      // Build LaTeX steps
      const stepHtmlArray = res.steps.map((step, idx) =>
        `<p class="step-title"><b>${idx + 1})</b> ${step.title}</p>
         <div class="centered-math">\\[${step.content}\\]</div>`);
      let stepsLatex = stepHtmlArray.join('');

      // Final step: Plotly graph
      let plotHtml = '';
      if (res.plot && res.plot.domain && res.plot.domain.length) {
        const graphStepIdx = res.steps.length + 1;
        plotHtml = `
          <p class="step-title"><b>${graphStepIdx})</b> Grafico della funzione:</p>
          <div id="plotlyGraph" style="width:100%;height:500px;"></div>`;
      }

      output.innerHTML = `<div class="result-section">${stepsLatex}${plotHtml}</div>`;
      output.dataset.latex = stepsLatex;

      // Use static SVG instead of the interactive div when saving to the notebook
      const staticHtml = res.plot && window.__lastPlotSVG
        ? stepsLatex + window.__lastPlotSVG
        : output.innerHTML;

      const payload = {
        algorithm: 'Studio di Funzione',
        input: expr,
        htmlOutput: staticHtml,
        output: stepsLatex,
        outputLatex: stepsLatex,
        rawData: res
      };
      window.currentExercise = payload;
      injectSaveButton(
        output.querySelector('.result-section'),
        payload
      );

      MathJax.typesetPromise([output]).then(scrollToOutput);
      if (res.plot && res.plot.domain && res.plot.domain.length) {
        renderPlot(res.plot);
      }
    }
  })
  .catch(err => {
      output.innerHTML = createErrorAlert(err.message);
      MathJax.typesetPromise([output]).then(scrollToOutput);
  })
  .finally(()=>{
    buttonIcon.innerHTML = '<i class="fas fa-play me-2"></i>';
  });
}

function resetStudio() {
  window.exprField.setValue('f(x)=\\placeholder[expr]{}');
  document.getElementById('output').innerHTML = 
    '<div class="empty-state text-center text-muted py-5">' +
      '<i class="fas fa-project-diagram fa-3x mb-3 opacity-50"></i>' +
      '<h6>Pronto</h6>' +
      '<p class="small">Inserisci un’espressione e premi “Analizza Funzione”.</p>' +
    '</div>';
}

function createErrorAlert(msg) {
  return (
    '<div class="alert alert-danger">' +
      '<i class="fas fa-exclamation-triangle me-2"></i>' +
      '<strong>Errore.</strong> ' + msg +
    '</div>'
  );
}

document.addEventListener('DOMContentLoaded', ()=>{
  window.exprField = document.getElementById('exprField');
  window.exprField.inlineShortcuts = {
    ...window.exprField.inlineShortcuts,
    '(x)': '(x)'
  };


  // Description toggle handling
  const descrCollapse = document.getElementById('descrizioneStudioFunzione');
  const descrText = document.getElementById('descrizioneText');
  const descrIcon = document.getElementById('descrizioneIcon');
  descrCollapse.addEventListener('hide.bs.collapse', () => {
    descrText.textContent = 'Mostra descrizione';
    descrIcon.classList.remove('fa-chevron-up');
    descrIcon.classList.add('fa-chevron-down');
  });
  descrCollapse.addEventListener('show.bs.collapse', () => {
    descrText.textContent = 'Nascondi descrizione';
    descrIcon.classList.remove('fa-chevron-down');
    descrIcon.classList.add('fa-chevron-up');
  });
});

function scrollToOutput() {
  if (window.__scrollAfterResult) {
    document.querySelector('.output-card').scrollIntoView({ behavior: 'smooth' });
    window.__scrollAfterResult = false;
  }
}

function renderPlot(plot) {
  // Target div
  const targetId = 'plotlyGraph';

  // Compute global horizontal range for function and asymptotes
  const rawMins = (plot.domain || []).map(d => (d[0] !== null ? d[0] : -100));
  const rawMaxs = (plot.domain || []).map(d => (d[1] !== null ? d[1] :  100));
  const globalMin = Math.min(...rawMins);
  const globalMax = Math.max(...rawMaxs);
  const deltaX = (globalMax - globalMin) * 0.1;
  const plotMin = globalMin - deltaX;
  const plotMax = globalMax + deltaX;

  // Compute vertical range from horizontal range using a fixed aspect ratio
  const rawYs = [
    ...(plot.extrema || []).map(p => p.y),
    ...(plot.zeros  || []).map(() => 0)
  ];
  const globalYMin = rawYs.length ? Math.min(...rawYs) : -10;
  const globalYMax = rawYs.length ? Math.max(...rawYs) : 10;
  const aspectRatio = 0.5;  // Altezza del grafico = 50% della larghezza (più compatto)
  const yCenter = (globalYMax + globalYMin) / 2;
  const xRange = plotMax - plotMin;
  const yHalfRange = (xRange * aspectRatio) / 2;
  const plotYMin = yCenter - yHalfRange;
  const plotYMax = yCenter + yHalfRange;

  // ——————————————————————————————————————————————
  // 1. Dataset for each continuous interval
  // ——————————————————————————————————————————————
  const datasets = (plot.domain || []).map(dom => {
    let a = (dom[0] !== null) ? dom[0] : -100;
    let b = (dom[1] !== null) ? dom[1] :  100;

    // Shift by a small epsilon if an interval bound overlaps a vertical asymptote
    const eps = 1e-3;
    (plot.asymptotes || []).forEach(as => {
      if (as.type === 'vertical') {
        if (a !== null && Math.abs(a - as.x) < 1e-9) a += eps;
        if (b !== null && Math.abs(b - as.x) < 1e-9) b -= eps;
      }
    });

    return {
      fn: plot.func,
      graphType: 'polyline',
      range: [plotMin, plotMax],
      skipTip: true,
      color: '#0065ff'
    };
  });

  // Global x-axis bounds (used to draw oblique asymptotes)
  const xMin = Math.min(...plot.domain.map(d => (d[0] !== null ? d[0] : -100)));
  const xMax = Math.max(...plot.domain.map(d => (d[1] !== null ? d[1] :  100)));

  // ——————————————————————————————————————————————
  // 2. Scatter points: zeros and extrema
  // ——————————————————————————————————————————————
  const scatters = [];

  // Larger zero markers with "zero" labels
  if (plot.zeros && plot.zeros.length) {
    // Enlarged red points
    scatters.push({
      graphType: 'scatter',
      points: plot.zeros.map(x => [x, 0]),
      fnType: 'points',
      color: 'red',
      attr: { r: 4 }      // raggio più piccolo
    });
    // "zero" label next to each point
    plot.zeros.forEach(x => {
      scatters.push({
        graphType: 'text',
        location: [x, 0.10],
        text: 'zero',
        attr: {
          'font-size': 11,
          fill: 'red',
          'text-anchor': 'middle'
        }
      });
    });
  }

  // Larger extrema markers with "max"/"min" labels
  if (plot.extrema && plot.extrema.length) {
    scatters.push({
      graphType: 'scatter',
      points: plot.extrema.map(p => [p.x, p.y]),
      fnType: 'points',
      color: 'blue',
      attr: { r: 4 }      // raggio più piccolo
    });
    // "max"/"min" text above each extremum
    plot.extrema.forEach(p => {
      scatters.push({
        graphType: 'text',
        location: [p.x, p.y + 0.25],
        text: p.nature === 'max' ? 'max' : 'min',
        attr: { 'font-size': 11, fill: 'blue', 'text-anchor': 'middle' }
      });
    });
  }

  // ——————————————————————————————————————————————
  // 2b. Oblique, horizontal, and vertical asymptotes as dashed red polylines
  // ——————————————————————————————————————————————
  const lineSets = (plot.asymptotes || []).map(a => {
    if (a.type === 'oblique') {
      return {
        fn: `${a.m} * x + (${a.q})`,
        graphType: 'polyline',
        range: [plotMin, plotMax],
        skipTip: true,
        color: '#ff0000',
        attr: { 'stroke-dasharray': '6,4' }
      };
    }
    if (a.type === 'horizontal') {
      return {
        fn: `${a.y}`,
        graphType: 'polyline',
        range: [plotMin, plotMax],
        skipTip: true,
        color: '#ff0000',
        attr: { 'stroke-dasharray': '6,4' }
      };
    }
    // vertical → polyline with two points
    if (a.type === 'vertical') {
      // Extend the vertical asymptote well beyond the visible area
      const yMin = -100;
      const yMax =  100;
      return {
        graphType: 'polyline',
        fnType: 'points',
        points: [[a.x, yMin], [a.x, yMax]],
        skipTip: true,
        color: '#ff0000',
        attr: { 'stroke-dasharray': '6,4' }
      };
    }
  }).filter(Boolean);

  // ——————————————————————————————————————————————
  // 4. Rendering with function-plot
  // ——————————————————————————————————————————————
  // Clear any previously rendered graph
  const targetEl = document.getElementById(targetId);
  if (targetEl) targetEl.innerHTML = '';

  functionPlot({
    target: `#${targetId}`,
    width: targetEl.clientWidth || 700,
    height: 450,
    yAxis: {
      label: '$f(x)$',
      domain: [plotYMin, plotYMax]
    },
    xAxis: { label: '$x$' },
    disableZoom: false,
    data: [...datasets, ...lineSets, ...scatters]
  });

  // Store SVG for notebook saving
  const svgEl = targetEl.querySelector('svg');
  window.__lastPlotSVG = svgEl ? svgEl.outerHTML : '';

  // Typeset LaTeX axis labels (works because they are plain <text>)
  if (window.MathJax) {
    MathJax.typesetPromise([targetEl]);
  }
}
</script>

<script src="https://unpkg.com/function-plot@1/dist/function-plot.js"></script>
<script src="../js/anti-autoscroll.js"></script>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/mathlive@0.92.0/dist/mathlive.min.js"></script>
  <script src="../js/layout-state.js"></script>
  <script src="../js/site-i18n.js"></script>
  <script src="../js/math-render-cache.js"></script>
  <script src="../js/config.js"></script>
  <script src="../js/component-loader.js"></script>
</body>
</html>
