<!DOCTYPE html>
<html lang="it" data-page-title="Potenze Modulari">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Potenze Modulari - Matrix Tools</title>
  <link rel="icon" href="/assets/icons/favicon.ico" sizes="any" />
  <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png" />
  <link rel="manifest" href="/assets/icons/site.webmanifest" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive-static.css" />
  <link href="/css/style.css" rel="stylesheet" />
  <link href="/css/panels-theme.css" rel="stylesheet" />
  
</head>
<body>
  <div id="navbar"></div>

  <div class="container-fluid" style="margin-top: 100px; padding: 0rem 1.5rem 0rem 0rem !important;">
    <div class="row">
    <div class="col-12 mb-4">
        <div class="card calculator-card modern-card shadow-lg">
            <div class="card-header modern-header">
                <h5 class="card-title mb-0 fw-bold">
                    <i class="fas fa-edit me-2"></i>Input
                </h5>
            </div>
            <div class="card-body modern-body">
                <div class="mb-4">
                    <button
                        id="toggleDescrizione"
                        class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#descrizioneModulari"
                        aria-expanded="false"
                        aria-controls="descrizioneModulari"
                    >
                        <i id="descrizioneIcon" class="fas fa-chevron-down rotate-icon"></i>
                        <span id="descrizioneText">Mostra descrizione</span>
                    </button>
                </div>

                <div id="descrizioneModulari" class="collapse mb-4">
                    <div class="card card-body mt-2">
                        <p class="text-muted">
                            Nel calcolo delle potenze modulari, si vuole determinare
                            il resto di un’espressione della forma:
                        </p>
                        <div class="text-center mb-3" style="font-size: 1.2rem">
                            \[ a^b \bmod n \]
                        </div>
                        <p class="text-muted small mb-0">
                            La potenza modulare è ampiamente usata in crittografia e
                            teoria dei numeri.
                        </p>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-semibold"
                        >Inserisci l'espressione:</label
                    >
                    <div style="text-align: center">
                        <math-field
                            id="modularField"
                            delete-mode="off"
                            default-mode="math"
                            read-only="partial"
                            class="math-input"
                            style="
                                font-size: 22px;
                                display: inline-block;
                                margin: 0 auto;
                            "
                        >
                            \placeholder[A]{}^\placeholder[B]{} \bmod
                            \placeholder[N]{}
                        </math-field>
                    </div>
                    <div
                        class="form-text mb-3"
                        style="font-size: 0.85rem; margin-top: 20px"
                    >
                        L’operazione \(a^b \bmod n\) si svolge nell’anello
                        unitario \(\mathbb{Z}_n\), l’insieme dei resti modulo
                        \(n\) con identità 1.
                    </div>
                </div>

                <form id="modularForm" onsubmit="return false;">
                    <div style="text-align: center; margin-top: 1px">
                        <button
                            id="modularButton"
                            onclick="invioModularPower()"
                            class="btn btn-primary btn-sm px-3"
                        >
                            <i class="fas fa-play me-2"></i>Calcola
                        </button>
                        <button
                            onclick="resetModularPower()"
                            class="btn btn-secondary btn-sm px-3 ms-1"
                        >
                            <i class="fas fa-eraser me-2"></i>Pulisci
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="card output-card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Output
                </h5>
            </div>
            <div class="card-body output-zone" id="output">
                <div class="empty-state text-center text-muted py-5">
                    <i class="fas fa-microchip fa-3x mb-3 opacity-50"></i>
                    <h6>Pronto per iniziare</h6>
                    <p class="small">Inserisci l’espressione nel campo.</p>
                </div>
                <!-- Save-to-notebook button - posizionato bottom-right -->
                <button class="save-to-notebook-btn" onclick="saveToNotebook()" title="Salva nel quaderno" style="display: none;">
                    <i class="fas fa-save"></i>
                    Salva
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function invioModularPower() {
        window.__scrollAfterResult = true;
        mostraModularExpression();
        const mf = window.modularField;
        const a = mf.getPromptValue("A")?.trim();
        const b = mf.getPromptValue("B")?.trim();
        const n = mf.getPromptValue("N")?.trim();
        // Remove eventuali parentesi LaTeX come \left( e \right)
        const clean = (val) => val.replace(/\\left\(|\\right\)/g, '').replace(/[()]/g, '');
        const aClean = clean(a);
        const bClean = clean(b);
        const nClean = clean(n);

        console.log("VALORI:", a, b, n);
        console.log("Tipo:", typeof a, typeof b, typeof n);

        if (!a || !b || !n) {
            const output = document.getElementById("output");
            output.innerHTML = createErrorAlert(
                "Inserire tutti i valori \\( a \\), \\( b \\) e \\( n \\).",
            );
            MathJax.typesetPromise([output]);
            if (window.__scrollAfterResult) {
                document
                    .querySelector(".output-card")
                    .scrollIntoView({ behavior: "smooth" });
                window.__scrollAfterResult = false;
            }
            return;
        }
        const output = document.getElementById("output");
        const button = document.getElementById("modularButton");
        const originalHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Calcola`;
        output.innerHTML = `<div class="text-center my-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Calcolo...</span>
        </div>
    </div>`;
        fetch("/api/modular-powers", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ base: +aClean, exponent: +bClean, modulo: +nClean }),
        })
            .then((r) => r.json())
            .then((res) => {
                const output = document.getElementById("output");
                if (!res.success) {
                    output.innerHTML = createErrorAlert(res.error);
                    MathJax.typesetPromise([output]);
                    if (window.__scrollAfterResult) {
                        document
                            .querySelector(".output-card")
                            .scrollIntoView({ behavior: "smooth" });
                        window.__scrollAfterResult = false;
                    }
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                    return;
                }

                let latexSteps = "";
                if (Array.isArray(res.latex)) {
                    latexSteps = res.latex
                        .map(
                            (step, idx) => `
                <p class="step-title"><b>${idx + 1})</b> ${step.title}</p>
                <p class="centered-math">\\[${step.content}\\]</p>
            `,
                        )
                        .join("");
                }
                const exprLatex = `${a}^{${b}} \\bmod ${n}`;
                latexSteps =
                    `<p class="step-title"><b>0)</b> Espressione inserita:</p>
    <p class="centered-math">\\[ ${exprLatex} \\]</p>` + latexSteps;

                // Prepare data for save button
                const inputText = `${a}^${b} mod ${n}`;
                
                output.innerHTML = `
            <div class="result-section">
                ${latexSteps}
                <div id="modularNotebookButton" class="mt-3"></div>
            </div>
        `;
                // Inject dynamic save button
                const payload = {
                    title: `Potenza Modulare: ${inputText}`,
                    algorithm: 'Potenze Modulari',
                    input: inputText,
                    htmlOutput: output.innerHTML,
                    outputLatex: latexSteps,
                    rawData: res
                };
                window.injectSaveButton(
                    document.getElementById("modularNotebookButton"),
                    payload
                );
                // Store the LaTeX source per il salvataggio nel notebook
                output.dataset.latex = latexSteps;

        
                // Store current exercise data for saving
                window.currentExercise = {
                    title: `Potenza Modulare: ${inputText}`,
                    algorithm: 'Potenze Modulari',
                    input: inputText,
                    htmlOutput: output.innerHTML,   // per GUI e PDF
                    outputLatex: latexSteps,        // per esportazione .tex
                    rawData: res
                };
                button.disabled = false;
                button.innerHTML = originalHTML;
                MathJax.typesetPromise([output]).then(() => {
                    if (window.__scrollAfterResult) {
                        document
                            .querySelector(".output-card")
                            .scrollIntoView({ behavior: "smooth" });
                        window.__scrollAfterResult = false;
                    }
                });
            })
            .catch((err) => {
                output.innerHTML = createErrorAlert(err.message);
                MathJax.typesetPromise([output]);
                button.disabled = false;
                button.innerHTML = originalHTML;
                if (window.__scrollAfterResult) {
                    document
                        .querySelector(".output-card")
                        .scrollIntoView({ behavior: "smooth" });
                    window.__scrollAfterResult = false;
                }
            });
    }

    function mostraModularExpression() {
        const mf = window.modularField;
        // simply ensure placeholder rendering
        MathJax.typesetPromise([mf]);
    }

    function resetModularPower() {
        const mf = window.modularField;
        mf.setValue(
            "\\placeholder[A]{}^\\placeholder[B]{} \\bmod \\placeholder[N]{}",
        );
        const output = document.getElementById("outputModular");
        output.innerHTML = `
        <div class="empty-state text-center text-muted py-5">
            <i class="fas fa-microchip fa-3x mb-3 opacity-50"></i>
            <h6>Pronto per iniziare</h6>
            <p class="small">Inserisci l’espressione nel campo e premi “Calcola”.</p>
        </div>`;
    }
    function createErrorAlert(message) {
        return `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Errore:</strong> ${message}
        </div>
    `;
    }
    
    // Save current exercise to notebook
    function saveCurrentExercise() {
        if (!window.currentExercise) {
            alert('Nessun esercizio da salvare. Risolvi prima un problema!');
            return;
        }
        
        const exercise = window.currentExercise;
        
        // Use the global saveToNotebook function from layout.html
        if (typeof window.saveToNotebook === 'function') {
            window.saveToNotebook(
                exercise.title,
                exercise.input, 
                exercise.output,
                exercise.algorithm
            );
        } else {
            alert('Funzione di salvataggio non disponibile. Ricarica la pagina.');
        }
    }
    document.addEventListener("DOMContentLoaded", () => {
        window.modularField = document.getElementById("modularField");
        const descrCollapse = document.getElementById("descrizioneModulari");
        const descrText = document.getElementById("descrizioneText");
        const descrIcon = document.getElementById("descrizioneIcon");

        descrCollapse.addEventListener("hide.bs.collapse", () => {
            descrText.textContent = "Mostra descrizione";
            descrIcon.classList.remove("fa-chevron-up");
            descrIcon.classList.add("fa-chevron-down");
        });
        descrCollapse.addEventListener("show.bs.collapse", () => {
            descrText.textContent = "Nascondi descrizione";
            descrIcon.classList.remove("fa-chevron-down");
            descrIcon.classList.add("fa-chevron-up");
        });
    });
</script>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/mathlive@0.92.0/dist/mathlive.min.js"></script>
  <script src="/js/layout-state.js"></script>
  <script src="/js/site-i18n.js"></script>
  <script src="/js/math-render-cache.js"></script>
  <script src="/js/component-loader.js"></script>
</body>
</html>
