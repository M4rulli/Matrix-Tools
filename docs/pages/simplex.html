<!DOCTYPE html>
<html lang="it" data-page-title="Metodo del Simplesso">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Metodo del Simplesso - Matrix Tools</title>
  <link rel="icon" href="/assets/icons/favicon.ico" sizes="any" />
  <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png" />
  <link rel="manifest" href="/assets/icons/site.webmanifest" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive-static.css" />
  <link href="/css/style.css" rel="stylesheet" />
  <link href="/css/panels-theme.css" rel="stylesheet" />
  
</head>
<body>
  <div id="navbar"></div>

  <div class="container-fluid" style="margin-top: 100px; padding: 0rem 1.5rem 0rem 0rem !important;">
    <!-- MathJax -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- MathLive -->
<link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css">
<script src="https://unpkg.com/mathlive/dist/mathlive.min.js"></script>

<div class="row">
  <!-- ========= INPUT CARD ========= -->
  <div class="col-12 mb-4">
    <div class="card calculator-card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">
          <i class="fas fa-edit me-2"></i>Input
        </h5>
      </div>
      <div class="card-body">
        <!-- ◆◆ Description (Show/Hide) ◆◆ -->

        <div class="mb-3">
          <button id="toggleDescrizione"
                  class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#descrizioneSimplesso"
                  aria-expanded="false"
                  aria-controls="descrizioneSimplesso">
            <i class="fas fa-chevron-down rotate-icon transition" id="descrizioneIcon"></i>
            <span id="descrizioneText">Mostra descrizione</span>
          </button>
        </div>
        <div class="collapse mb-3" id="descrizioneSimplesso">
          <div class="card card-body bg-light border mt-2">
            <p class="text-muted">
              Sia un problema di programmazione lineare nella forma:<br>
              \[\; \begin{aligned}
                  &\text{\( \max \) (o \( \min \)) } && z = c^{\mathsf T}x \\
                  &\text{soggetto a } && Ax = b, \quad x \ge 0 ,
              \end{aligned}\]
              dove \(A\in\mathbb{R}^{m\times n}\), \(b\in\mathbb{R}^m\) e \(c\in\mathbb{R}^n\). Il <em>dizionario del Simplesso</em> è una scrittura esplicita di tutte
              le variabili <strong>di base</strong> \(x_B\) in funzione delle
              <strong>non‑base</strong> \(x_N\):
              \[
                x_B = b - P\,x_N,\qquad
                z   = z_0 + q^{\mathsf T}x_N .
              \]
              Ad ogni iterazione si sceglie una variabile entrante
              (coefficiente ridotto \(q_j &gt; 0\) nel caso di massimizzazione) e una
              variabile uscente (test del rapporto minimo), effettuando un
              <em>pivot</em> che sostituisce \(x_j\) nella base.  
              Il procedimento termina quando tutti i costi ridotti soddisfano il
              criterio di ottimalità, fornendo la soluzione ottima e il valore di \(z\).  
              Il <em>tableau</em> del Simplesso, equivalente al dizionario ma con
              scrittura matriciale compatta.
            </p>
          </div>
        </div>

        <!-- ◆◆ Tipo di function (max/min) ◆◆ -->
        <div class="mb-3">
          <label for="tipoFunzione" class="form-label fw-semibold">Tipo di problema:</label>
          <select id="tipoFunzione" class="form-select form-select-sm w-auto">
            <option value="max" selected>Massimizzazione</option>
            <option value="min">Minimizzazione</option>
          </select>
        </div>

        <!-- ◆◆ Numero di constraints ◆◆ -->
        <div class="mb-3">
          <label for="dimensionSelect" class="form-label fw-semibold">
            Numero di vincoli (righe):
          </label>
          <select id="dimensionSelect" class="form-select form-select-sm w-auto" onchange="updateSimplessoField()">
            <option value="2">2 vincoli</option>
            <option value="3" selected>3 vincoli</option>
            <option value="4">4 vincoli</option>
          </select>
        </div>

        <!-- ◆◆ Campo MathLive ◆◆ -->
        <div class="mb-3">
          <label for="simplessoField" class="form-label fw-semibold">
            Inserisci il problema:
          </label>
          <math-field id="simplessoField"
                      delete-mode="off"
                      default-mode="math"
                      read-only="partial"
                      class="math-input"
                      style="font-size: 22px;">
          </math-field>
      <div class="form-text">
        Usa le variabili \(x_1, x_2, \dots\) e inserisci numeri interi o frazioni. Per le disequazioni digita <code>>=</code> per \( \ge\) e <code><=</code> per \( \le\). <strong>Al momento</strong>, l’algoritmo non è in grado di risolvere problemi il cui dizionario iniziale non è ammissibile e che richiederebbero l’uso di una variabile ausiliaria; in tali casi, l’esecuzione verrà interrotta con un messaggio esplicativo.
      </div>
        </div>

        <!-- ◆◆ Pulsanti ◆◆ -->
        <div class="text-center mt-3">
          <button id="solveButton" onclick="computeSimplesso()" class="btn btn-primary btn-sm px-3">
            <i class="fas fa-play me-2"></i>Risolvi
          </button>
          <button onclick="resetSimplesso()" class="btn btn-secondary btn-sm px-3 ms-1">
            <i class="fas fa-eraser me-2"></i>Pulisci
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========= OUTPUT CARD ========= -->
  <div class="col-12">
    <div class="card output-card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-line me-2"></i>Output
        </h5>
      </div>
      <div class="card-body" id="output">
        <div class="empty-state text-center text-muted py-5">
          <i class="fas fa-calculator fa-3x mb-3 opacity-50"></i>
          <h6>Pronto per calcolare</h6>
          <p class="small">Seleziona la dimensione, inserisci il problema e premi "Risolvi".</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Script semplificato -->
<script>
function placeholderKey(i, j) {
  return 'p' + i + j;
}

function buildSimplessoLatex(n, tipo) {
  const goal = (tipo === 'min') ? '{\\min } z = ' : '{\\max } z = ';
  let lines = [];
  lines.push(goal + '\\placeholder[obj]{}' + ':');
  // uno placeholder per vincolo
  for (let i = 1; i <= n; i++) {
    lines.push('\\placeholder[row' + i + ']{}');
  }
  // non negatività
  lines.push('x_{1},x_{2},...,x_{n} \\ge 0');
  return '\\begin{aligned}' + lines.join('\\\\ ') + '\\end{aligned}';
}

function readSimplesso(n) {
  const field = window.simplessoField;
  const obj = field.getPromptValue('obj')?.trim();
  if (!obj) return null;
  let constraints = [];
  for (let i = 1; i <= n; i++) {
    const row = field.getPromptValue('row' + i)?.trim();
    if (!row) return null;
    let parts;
    if (row.includes('>=')) {
      parts = row.split('>=');
    } else if (row.includes('<=')) {
      parts = row.split('<=');
    } else if (row.includes('\\ge')) {
      parts = row.split('\\ge');
    } else if (row.includes('\\le')) {
      parts = row.split('\\le');
    } else {
      return null;
    }
    if (parts.length !== 2) return null;
    constraints.push([parts[0].trim(), parts[1].trim(), row.includes('>=')||row.includes('\\ge')?'>=':'<=']);
  }
  return { obj, constraints };
}

function updateSimplessoField() {
  const n = parseInt(document.getElementById('dimensionSelect').value, 10);
  const tipo = document.getElementById('tipoFunzione').value;
  window.simplessoField.setValue(buildSimplessoLatex(n, tipo));
}

function resetSimplesso() {
  updateSimplessoField();
  const output = document.getElementById('output');
  output.innerHTML = `
    <div class="empty-state text-center text-muted py-5">
      <i class="fas fa-calculator fa-3x mb-3 opacity-50"></i>
      <h6>Pronto per calcolare</h6>
      <p class="small">Seleziona la dimensione, inserisci il problema e premi "Risolvi".</p>
    </div>`;
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('tipoFunzione').addEventListener('change', updateSimplessoField);
  window.simplessoField = document.getElementById('simplessoField');
  resetSimplesso();

  const descrizioneCollapse = document.getElementById('descrizioneSimplesso');
  const descrizioneText = document.getElementById('descrizioneText');
  const descrizioneIcon = document.getElementById('descrizioneIcon');
  descrizioneCollapse.addEventListener('hide.bs.collapse', () => {
    descrizioneText.textContent = 'Mostra descrizione';
    descrizioneIcon.classList.remove('fa-chevron-up');
    descrizioneIcon.classList.add('fa-chevron-down');
  });
  descrizioneCollapse.addEventListener('show.bs.collapse', () => {
    descrizioneText.textContent = 'Nascondi descrizione';
    descrizioneIcon.classList.remove('fa-chevron-down');
    descrizioneIcon.classList.add('fa-chevron-up');
  });
});

function computeSimplesso() {
  const n = parseInt(document.getElementById('dimensionSelect').value, 10);
  const tipo = document.getElementById('tipoFunzione').value;
  const input = readSimplesso(n);
  const output = document.getElementById('output');

  if (!input) {
    output.innerHTML = '<div class="alert alert-danger">Inserisci tutti i coefficienti e termini noti.</div>';
    MathJax.typesetPromise([output]);
    return;
  }

  const btn = document.getElementById('solveButton');
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Calcolo...';
  output.innerHTML = '<div class="text-center my-3"><div class="spinner-border text-primary"></div></div>';
  output.scrollIntoView({ behavior: 'smooth', block: 'start' });

  fetch('/api/simplex', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ tipo, n, ...input })
  })
  .then(r => r.json())
  .then(res => {
    btn.disabled = false;
    btn.innerHTML = originalHTML;
    if (!res.success) {
      output.innerHTML = `<div class="alert alert-danger">${res.error}</div>`;
    } else {
      let latex = '';
      const container = document.createElement('div');
      res.steps.forEach((step, i) => {
        container.insertAdjacentHTML('beforeend',
          `<p class="step-title"><b>${i})</b> ${step.title || ''}</p>
           <p class="centered-math">\\[${step.content}\\]</p>`);
        latex += `${i}) ${step.title || ''}\n\\[${step.content}\\]\n`;
      });

      const saveDiv = document.createElement('div');
      saveDiv.id = 'simplessoNotebookButton';
      saveDiv.classList.add('mt-3');
      container.appendChild(saveDiv);

      if (typeof window.injectSaveButton === 'function') {
        const payload = {
          title: 'Metodo del Simplesso',
          algorithm: 'Metodo del Simplesso (standard)',
          input: JSON.stringify(input),
          htmlOutput: container.outerHTML,
          outputLatex: latex,
          rawData: res
        };
        window.injectSaveButton(saveDiv, payload);
      }

      output.dataset.latex = latex;
      output.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.className = 'result-section';
      wrapper.appendChild(container);
      output.appendChild(wrapper);

      MathJax.typesetPromise([output]);
    }
  })
  .catch(err => {
    btn.disabled = false;
    btn.innerHTML = originalHTML;
    output.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
  });
}
</script>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/mathlive@0.92.0/dist/mathlive.min.js"></script>
  <script src="/js/layout-state.js"></script>
  <script src="/js/site-i18n.js"></script>
  <script src="/js/math-render-cache.js"></script>
  <script src="/js/component-loader.js"></script>
</body>
</html>
