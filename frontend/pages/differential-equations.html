<!DOCTYPE html>
<html lang="it" data-page-title="Equazioni Differenziali">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Equazioni Differenziali - Matrix Tools</title>
  <link rel="icon" href="/static/icons/favicon.ico" sizes="any" />
  <link rel="icon" type="image/svg+xml" href="/static/icons/favicon.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png" />
  <link rel="manifest" href="/static/icons/site.webmanifest" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive-static.css" />
  <link href="/static/style.css" rel="stylesheet" />
  <link href="/static/panels-theme.css" rel="stylesheet" />
  
</head>
<body>
  <div id="navbar"></div>

  <div class="container-fluid" style="margin-top: 100px; padding: 0rem 1.5rem 0rem 0rem !important;">
    <style>
  .math-input    { font-size: 22px; display: inline-block; margin: 0 auto; }
  .step-title    { margin-top: 1em; }
  .centered-math { text-align: center; }
  .rotate-icon   { transition: transform 0.3s ease; }
  .eq-builder    { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
  .eq-static     { font-size: 1.1rem; font-weight: 600; white-space: nowrap; }
  .calculator-card {
    min-height: initial !important;
    height: auto !important;
  }
</style>

<div class="row">
  <div class="col-12 mb-4">
    <div class="card calculator-card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0"><i class="fas fa-edit me-2"></i>Input</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <button id="toggleDescrizione"
                  class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#descrizioneEqDiff"
                  aria-expanded="false"
                  aria-controls="descrizioneEqDiff">
            <i id="descrizioneIcon" class="fas fa-chevron-down rotate-icon"></i>
            <span id="descrizioneText">Mostra descrizione</span>
          </button>
        </div>

        <div id="descrizioneEqDiff" class="collapse mb-3">
          <div class="card card-body bg-light border mt-2">
            <p class="text-muted mb-2">
              Consideriamo un’equazione differenziale lineare a coefficienti costanti:
              \[
                P(\Delta)\,y(t)=u(t),
              \]
              dove \(P(\Delta)\) è un polinomio nell’operatore differenziale
              \(\Delta=\frac{d}{dt}\).
            </p>

            <p class="text-muted mb-2">
              Il metodo degli <strong>annichilatori</strong> consiste nel determinare un
              operatore \(A(\Delta)\) tale che
              \[
                A(\Delta)\,u(t)=0.
              \]
              Applicando \(A(\Delta)\) a entrambi i membri dell’equazione si ottiene
              un’equazione omogenea di ordine superiore, risolvibile tramite
              l’equazione caratteristica. La soluzione generale è data dalla somma della soluzione dell’equazione
              omogenea associata a \(P(\Delta)\) e di una soluzione particolare
              compatibile con il termine noto \(u(t)\).
            </p>

            <p class="text-muted mb-2">
              Una volta determinata la soluzione generale dell’equazione differenziale,
              si procede all’imposizione delle <strong>condizioni iniziali</strong>.
              Se \(\deg(P(\Delta))=n\), l’equazione è di ordine \(n\) e sono necessarie \(n\)
              condizioni iniziali indipendenti per determinare univocamente le costanti arbitrarie.
              Tipicamente si assumono condizioni nella forma:
            </p>

            <p class="text-muted mb-2">
              \[
                y(0)=y_0,\quad y'(0)=y_1,\quad \dots,\quad y^{(n-1)}(0)=y_{n-1}.
              \]
            </p>

            <p class="text-muted mb-2">
              L’imposizione delle condizioni iniziali consente di determinare in modo
              univoco le costanti arbitrarie presenti nella soluzione generale e di
              ottenere la soluzione fisicamente significativa del problema.
            </p>

  
          </div>
        </div>

        <div class="mb-2">
          <p class="form-label fw-semibold">
            Inserisci un’equazione differenziale della forma \(P(\Delta)\,y(t)=u(t)\)
          </p>
          <div class="mb-2">
            <math-field id="equationField"
                        delete-mode="off"
                        default-mode="math"
                        read-only="partial"
                        class="math-input"
                        style="width:100%;">
              \placeholder[pdelta]{}\,y(t)=\placeholder[rhs]{}
            </math-field>
          </div>
        </div>

        <div class="mb-3">
          <label for="numCondizioni" class="form-label fw-semibold">
            Numero di condizioni iniziali:
          </label>
          <select id="numCondizioni" class="form-select form-select-sm" style="max-width:200px;">
            <option value="0" selected>Nessuna</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </div>

        <div id="condizioniContainer" class="mb-3" style="display:none;">
          <math-field id="condizioniField"
                      class="math-input"
                      delete-mode="off"
                      default-mode="math"
                      read-only="partial"
                      style="width:100%;">
          </math-field>
        </div>

        <div class="form-text mb-2" style="font-size: 0.85rem;">
          Per inserire l’operatore differenziale \(\Delta\) puoi digitare <code>D</code>
          (oppure <code>\Delta</code>). La funzione esponenziale può essere inserita tramite <code>exp(...)</code>.
          L’algoritmo calcola la soluzione generale dell’equazione differenziale e, se presenti,
          impone le condizioni iniziali.
        </div>

        <div class="text-center mt-1">
          <button id="calcButton" class="btn btn-primary btn-sm px-3" onclick="calcolaEquazioneDifferenziale()">
            <span id="calcButtonIcon"><i class="fas fa-play me-2"></i></span>
            Calcola
          </button>
          <button class="btn btn-secondary btn-sm px-3 ms-1" onclick="resetEqDiff()">
            <i class="fas fa-eraser me-2"></i>Pulisci
          </button>
        </div>
        <style>
          .calculator-card .card-body { padding-bottom: 1rem; }
        </style>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card output-card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0"><i class="fas fa-stream me-2"></i>Output</h5>
      </div>
      <div class="card-body" id="output">
        <div class="empty-state text-center text-muted py-5">
          <i class="fas fa-wave-square fa-3x mb-3 opacity-50"></i>
          <h6>Pronto</h6>
          <p class="small">Inserisci un'equazione e premi "Calcola".</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function buildCondizioni(n) {
  const container = document.getElementById('condizioniContainer');
  const mf = document.getElementById('condizioniField');

  if (!mf) return;

  if (!n || n <= 0) {
    container.style.display = 'none';
    mf.setValue('');
    return;
  }

  container.style.display = 'block';

  // Single inline row: y(0)=□  y'(0)=□  y''(0)=□ ...
  let parts = [];
  for (let i = 0; i < n; i++) {
    const deriv = i === 0 ? 'y' : `y^{(${i})}`;
    parts.push(`${deriv}(0)=\\placeholder[c${i}]{y_${i}}`);
  }
  mf.setValue(parts.join('\\quad '));
}

document.getElementById('numCondizioni')
  .addEventListener('change', e => {
    buildCondizioni(parseInt(e.target.value, 10));
  });

function createErrorAlert(msg) {
  return (
    '<div class="alert alert-danger">' +
      '<i class="fas fa-exclamation-triangle me-2"></i>' +
      '<strong>Errore.</strong> ' + msg +
    '</div>'
  );
}

function scrollToOutput() {
  document.querySelector('.output-card').scrollIntoView({ behavior: 'smooth' });
}

function calcolaEquazioneDifferenziale() {
  const buttonIcon = document.getElementById('calcButtonIcon');
  const output = document.getElementById('output');
  const pDeltaRaw = window.equationField.getPromptValue('pdelta')?.trim();
  const rhsRaw = window.equationField.getPromptValue('rhs')?.trim();

  const pDelta = pDeltaRaw || '';
  const rhs = rhsRaw || '';

  if (!pDelta || !rhs) {
    output.innerHTML = createErrorAlert("Inserisci sia P(Δ) sia il termine noto.");
    MathJax.typesetPromise([output]);
    return;
  }

  const equation = `${pDelta}y=${rhs}`;

  buttonIcon.innerHTML =
    '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>';
  output.innerHTML =
    '<div class="text-center my-3">' +
      '<div class="spinner-border text-primary" role="status">' +
        '<span class="visually-hidden">Calcolo...</span>' +
      '</div>' +
    '</div>';

  const condizioni = [];
  const nCond = parseInt(document.getElementById('numCondizioni').value, 10) || 0;
  const mfCond = document.getElementById('condizioniField');

  for (let i = 0; i < nCond; i++) {
    let v = mfCond ? mfCond.getPromptValue(`c${i}`) : null;
    if (v === null || v === undefined || v.trim() === "") {
      v = "0";
    }
    condizioni.push(v);
  }

  fetch('/api/differential-equations', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      equazione: equation,
      condizioniIniziali: condizioni
    })
  })
  .then(r => r.json())
  .then(res => {
    if (!res.success) {
      output.innerHTML = createErrorAlert(res.error || "Errore nel calcolo.");
      MathJax.typesetPromise([output]).then(scrollToOutput);
      return;
    }

    let step0 = `
      <p class="step-title"><b>0)</b> Equazione differenziale assegnata:</p>
      <p class="centered-math">\\[${pDelta}\\,y(t)=${rhs}\\]</p>
    `;

    const steps = Array.isArray(res.latex) ? res.latex : [];
    const stepHtml =
      step0 +
      steps.map((step, i) =>
        `<p class="step-title"><b>${i + 1})</b> ${step.title}</p>
         <p class="centered-math">\\[${step.content}\\]</p>`
      ).join('');

    output.innerHTML = `<div class="result-section">${stepHtml}</div>`;
    output.dataset.latex = stepHtml;

    const payload = {
      title: 'Equazione Differenziale',
      algorithm: 'Equazione Differenziale',
      input: `${pDelta}y(t)=${rhs}`,
      htmlOutput: output.innerHTML,
      outputLatex: stepHtml,
      rawData: res
    };
    window.currentExercise = payload;
    injectSaveButton(output.querySelector('.result-section'), payload);

    MathJax.typesetPromise([output]).then(scrollToOutput);
  })
  .catch(err => {
    output.innerHTML = createErrorAlert(err.message);
    MathJax.typesetPromise([output]).then(scrollToOutput);
  })
  .finally(() => {
    buttonIcon.innerHTML = '<i class="fas fa-play me-2"></i>';
  });
}

function resetEqDiff() {
  if (window.equationField) {
    window.equationField.setValue('\\placeholder[pdelta]{}\\,y(t)=\\placeholder[rhs]{}');
  }
  document.getElementById('numCondizioni').value = '0';
  const cc = document.getElementById('condizioniContainer');
  const mf = document.getElementById('condizioniField');
  if (mf) mf.setValue('');
  if (cc) cc.style.display = 'none';

  document.getElementById('output').innerHTML =
    '<div class="empty-state text-center text-muted py-5">' +
      '<i class="fas fa-wave-square fa-3x mb-3 opacity-50"></i>' +
      '<h6>Pronto</h6>' +
      '<p class="small">Inserisci un\'equazione e premi "Calcola".</p>' +
    '</div>';
}

document.addEventListener('DOMContentLoaded', () => {
  window.equationField = document.getElementById('equationField');

  // Use MathLive inlineShortcuts to transform D into \\Delta
  window.equationField.inlineShortcuts = {
    ...window.equationField.inlineShortcuts,
    'D': '\\Delta'
  };

  const condField = document.getElementById('condizioniField');
  if (condField) {
    condField.inlineShortcuts = {
      ...condField.inlineShortcuts,
      'D': '\\Delta'
    };
  }

  const descrCollapse = document.getElementById('descrizioneEqDiff');
  const descrText = document.getElementById('descrizioneText');
  const descrIcon = document.getElementById('descrizioneIcon');

  descrCollapse.addEventListener('hide.bs.collapse', () => {
    descrText.textContent = 'Mostra descrizione';
    descrIcon.classList.remove('fa-chevron-up');
    descrIcon.classList.add('fa-chevron-down');
  });
  descrCollapse.addEventListener('show.bs.collapse', () => {
    descrText.textContent = 'Nascondi descrizione';
    descrIcon.classList.remove('fa-chevron-down');
    descrIcon.classList.add('fa-chevron-up');
  });
});
</script>

<script src="/static/js/anti-autoscroll.js"></script>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/mathlive@0.92.0/dist/mathlive.min.js"></script>
  <script src="/static/js/layout-state.js"></script>
  <script src="/static/js/site-i18n.js"></script>
  <script src="/static/js/math-render-cache.js"></script>
  <script src="/frontend/js/component-loader.js"></script>
</body>
</html>
