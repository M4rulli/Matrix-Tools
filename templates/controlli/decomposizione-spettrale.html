{% extends "layout.html" %}

{% block topbar_title %}
<h2 class="navbar-brand mb-0 fw-bold">
    Decomposizione Spettrale
</h2>
{% endblock %}

{% block algorithm_content %}
<style>
  .math-input      { font-size: 22px; display:inline-block; margin:0 auto; }
  .step-title      { margin-top:1em; }
  .centered-math   { text-align:center; }
  .rotate-icon     { transition:transform .3s ease; }
</style>

<div class="row">
  <!-- ▲▲▲  INPUT  ▲▲▲ -->
  <div class="col-12 mb-4">
    <div class="card calculator-card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0"><i class="fas fa-edit me-2"></i>Input</h5>
      </div>
      <div class="card-body">

        <!-- Descrizione collassabile -->
        <div class="mb-3">
          <button id="toggleDescrizione"
                  class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
                  type="button" data-bs-toggle="collapse"
                  data-bs-target="#descrizioneSpettrale"
                  aria-expanded="false" aria-controls="descrizioneSpettrale">
            <i id="descrizioneIcon" class="fas fa-chevron-down rotate-icon transition"></i>
            <span id="descrizioneText">Mostra descrizione</span>
          </button>
        </div>

        <div id="descrizioneSpettrale" class="collapse mb-3">
          <div class="card card-body bg-light border mt-2">
            <p class="text-muted text-justify">
              Ogni matrice quadrata \(A\in\mathbb{C}^{n\times n}\) ammette una decomposizione spettrale della forma:
              \[
                  A = D + N, \qquad DN = ND, \qquad N\text{ nilpotente},
              \]
              dove \(D\) è diagonalizzabile e \(N\) è la parte nilpotente. Questa è nota come decomposizione di <strong>Dunford</strong>.
            </p>
            <p class="text-muted text-justify small">
              Il calcolo si basa sul polinomio caratteristico
              \(P(s) = \det(sI - A)\), da cui si estraggono gli autovalori distinti \(\lambda_1,\dots,\lambda_k\) e si costruiscono le funzioni razionali
              \(f_i(s) = \frac{e_i(s)}{P(s)}\) per ottenere i proiettori spettrali \(E_i = e_i(A)\).
              <br>Segue la costruzione:
              \[
                  D = \sum_{i=1}^k \lambda_i E_i, \qquad N = A - D.
              \]
            </p>
            <p class="text-muted text-justify small">
              La decomposizione permette di calcolare esponenziali e potenze:
              \[
                  e^{At} = e^{Dt} \sum_{k=0}^{\nu - 1} \frac{t^k N^k}{k!}, \qquad
                  A^t = D^t \sum_{k=0}^{\nu - 1} \binom{t}{k} N^k,
              \]
              dove \(\nu\) è l'indice di nilpotenza di \(N\), e
              \[
                  e^{Dt} = \sum_{i=1}^k e^{\lambda_i t} E_i, \qquad
                  D^t = \sum_{i=1}^k \lambda_i^t E_i.
              \]
            </p>
          </div>
        </div>

        <!-- Selettore dimensione matrice -->
        <div class="mb-3">
          <label for="matrixSizeSelect" class="form-label fw-semibold">
            Dimensione matrice:
          </label>
          <select id="matrixSizeSelect" class="form-select">
            <option value="2">2×2</option>
            <option value="3" selected>3×3</option>
            <option value="4">4×4</option>
          </select>
        </div>

        <!-- MathLive matrix input -->
        <div class="mb-3">
          <label for="matrixField" class="form-label">Matrice \(A\):</label>
          <math-field id="matrixField"
                      delete-mode="off"
                      default-mode="math"
                      read-only="partial"
                      class="math-input"
                      style="width:100%;">
              A=\placeholder[matrix]{}
          </math-field>
        </div>

      <div class="form-text mb-3" style="font-size:.85rem;">
        Le celle lasciate vuote verranno considerate come zeri. Il sistema calcola automaticamente la decomposizione spettrale della matrice \(A\), e successivamente determina le matrici esponenziale \(e^{At}\) e potenza \(A^t\).
      </div>

        <!-- Pulsanti azione -->
        <div class="text-center mt-3">
          <button id="spectralBtn" class="btn btn-primary btn-sm px-3" onclick="analizzaSpettrale()">
            <span id="spectralBtnIcon"><i class="fas fa-play me-2"></i></span>
            Decomponi
          </button>
          <button class="btn btn-secondary btn-sm px-3 ms-1" onclick="resetMatrix()">
            <i class="fas fa-eraser me-2"></i>Pulisci
          </button>
        </div>

      </div><!-- /card-body -->
    </div><!-- /card -->
  </div><!-- /col -->

  <!-- ▼▼▼  OUTPUT  ▼▼▼ -->
  <div class="col-12">
    <div class="card output-card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-line me-2"></i>Output
        </h5>
      </div>
      <div class="card-body" id="output">
        <div class="empty-state text-center text-muted py-5">
          <i class="fas fa-project-diagram fa-3x mb-3 opacity-50"></i>
          <h6>Pronto</h6>
          <p class="small">Inserisci la matrice e premi “Decomponi”.</p>
        </div>
      </div>
    </div>
  </div>
</div><!-- /.row -->

<!-- ============================================================= -->
<script>
/* -----------------------------------------------------------------
 *  Helper: costruisci LaTeX placeholder per matrice n×n
 * ---------------------------------------------------------------- */
function buildMatrixPlaceholder(n) {
  let rows = [];
  for (let i = 0; i < n; ++i) {
    let cols = [];
    for (let j = 0; j < n; ++j) {
      cols.push(`\\placeholder[a${i}${j}]{}`);
    }
    rows.push(cols.join('&'));
  }
  return `\\begin{bmatrix}${rows.join('\\\\')}\\end{bmatrix}`;
}

/* Aggiorna la matrice quando cambia il selettore */
const sizeSelect  = document.getElementById('matrixSizeSelect');
const matrixField = document.getElementById('matrixField');
function refreshMatrix() {
  const n = parseInt(sizeSelect.value, 10);
  matrixField.setValue(`A=${buildMatrixPlaceholder(n)}`);
}
sizeSelect.addEventListener('change', refreshMatrix);
document.addEventListener('DOMContentLoaded', refreshMatrix);

/* ---------------------------------------------------------------
 *  PULSANTE PULISCI – svuota solo le celle
 * ------------------------------------------------------------- */
function resetMatrix() {
  refreshMatrix();
  document.getElementById('output').innerHTML = `
    <div class="empty-state text-center text-muted py-5">
      <i class="fas fa-project-diagram fa-3x mb-3 opacity-50"></i>
      <h6>Pronto</h6>
      <p class="small">Inserisci la matrice e premi “Decomponi”.</p>
    </div>`;
}

/* ---------------------------------------------------------------
 *  ANALISI – chiamata API
 * ------------------------------------------------------------- */
function analizzaSpettrale() {
  const n = parseInt(sizeSelect.value, 10);
  /* ==== Costruisci array di celle leggendo i singoli placeholder aij === */
  const rows = [];
  for (let i = 0; i < n; ++i) {
    const row = [];
    for (let j = 0; j < n; ++j) {
      const id = `a${i}${j}`;
      const cell = (matrixField.getPromptValue(id)?.trim() || "0")
                    .replace(/\\,/g, ''); // rimuovi eventuali separatori
      row.push(cell === "" ? "0" : cell);
    }
    rows.push(row);
  }

  /* Verifica che non siano tutti zeri / vuoti */
  if (rows.flat().every(c => c === "0" || c === "")) {
    document.getElementById('output').innerHTML =
      createErrorAlert('Inserisci la matrice.');
    return;
  }

  /* Ricostruisci LaTeX per Step 0 */
  const latexRows = rows
      .map(r => r.join(' & '))
      .join(' \\\\ ');
  const latexMatrix = `\\begin{bmatrix}${latexRows}\\end{bmatrix}`;

  /* Spinner ON */
  const btnIcon = document.getElementById('spectralBtnIcon');
  btnIcon.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status"></span>`;

  const output = document.getElementById('output');
  output.innerHTML = `<div class="text-center my-3">
    <div class="spinner-border text-primary"><span class="visually-hidden">Calcolo…</span></div></div>`;

  fetch('/api/decomposizione-spettrale', {
    method : 'POST',
    headers: {'Content-Type':'application/json'},
    body   : JSON.stringify({ n, matrix: rows })
  })
  .then(r => r.json())
  .then(res => {
    if (!res.success) {
      output.innerHTML = createErrorAlert(res.error);
    } else if (Array.isArray(res.latex)) {
      let html = "";
      res.latex.forEach((step, idx) => {
        html += `<p class="step-title"><b>${idx})</b> ${step.title}</p>
                 <p class="centered-math">\\[${step.content}\\]</p>`;
      });

      const resultDiv = document.createElement('div');
      resultDiv.className = 'result-section';
      resultDiv.innerHTML = html;
      output.innerHTML = '';
      output.appendChild(resultDiv);
      output.dataset.latex = html;

      /* Notebook payload + bottone */
      const payload = {
        title       : 'Decomposizione Spettrale',
        algorithm   : 'Decomposizione Spettrale',
        input       : latexMatrix,
        htmlOutput  : resultDiv.outerHTML,
        outputLatex : html,
        rawData     : res
      };
      window.currentExercise = payload;
      injectSaveButton(resultDiv, payload);

      /* MathJax render + scroll */
      if (window.MathJax && window.MathJax.typesetPromise) {
        MathJax.typesetPromise([output]).then(scrollToOutput);
      } else {
        scrollToOutput();
      }
    }
  })
  .catch(err => {
    output.innerHTML = createErrorAlert(err.message);
  })
  .finally(()=>{ btnIcon.innerHTML = '<i class="fas fa-play me-2"></i>'; });
}

/* ---------------------------------------------------------------
 *  Strumenti di utilità
 * ------------------------------------------------------------- */
function createErrorAlert(msg) {
  return `<div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Errore:</strong> ${msg}</div>`;
}
function scrollToOutput() {
  document.querySelector('.output-card')
          .scrollIntoView({behavior:'smooth'});
}

/* ---------------------------------------------------------------
 *  Toggle testo descrizione
 * ------------------------------------------------------------- */
const descrCollapse = document.getElementById('descrizioneSpettrale');
const descrText     = document.getElementById('descrizioneText');
const descrIcon     = document.getElementById('descrizioneIcon');
descrCollapse.addEventListener('hide.bs.collapse', ()=>{
  descrText.textContent = 'Mostra descrizione';
  descrIcon.classList.replace('fa-chevron-up','fa-chevron-down');
});
descrCollapse.addEventListener('show.bs.collapse', ()=>{
  descrText.textContent = 'Nascondi descrizione';
  descrIcon.classList.replace('fa-chevron-down','fa-chevron-up');
});
</script>

<script src="{{ url_for('static', filename='js/anti-autoscroll.js') }}"></script>
{% endblock %}