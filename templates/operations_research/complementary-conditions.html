{% extends "layout.html" %}

{% block styles %}
<style>
.result-section{
  background:#fcfcff;border:1px solid #e6e6f0;border-radius:12px;padding:1.5rem;margin-top:1rem;
}
.rotate-icon{transition:transform .3s ease;}
.step-title{margin-top:1em;}
.centered-math{text-align:center;}
</style>
{% endblock %}

{% block topbar_title %}
<h2 class="navbar-brand mb-0 fw-bold">Cond. di Complementarità</h2>
{% endblock %}

{% block algorithm_content %}
<!-- MathJax -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- MathLive -->
<link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css">
<script src="https://unpkg.com/mathlive/dist/mathlive.min.js"></script>

<div class="row">
  <!-- INPUT -->
  <div class="col-12 mb-4">
    <div class="card calculator-card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0"><i class="fas fa-edit me-2"></i>Input</h5>
      </div>
      <div class="card-body">
        <!-- description -->
        <div class="mb-3">
          <button id="toggleDescrizione" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
            type="button" data-bs-toggle="collapse" data-bs-target="#descrizioneCC" aria-expanded="false"
            aria-controls="descrizioneCC">
            <i id="descrizioneIcon" class="fas fa-chevron-down rotate-icon transition"></i>
            <span id="descrizioneText">Mostra descrizione</span>
          </button>
        </div>
        <div id="descrizioneCC" class="collapse mb-3">
          <div class="card card-body bg-light border mt-2">
            <p class="text-muted">
              Sia dato il <em>primale</em>:
              \[
                 (P)\; \min\;c^{\mathsf T}x\quad\text{s.t. }Ax=b,\;x\ge0,\qquad
                 A\in\mathbb R^{m\times n},\;b\in\mathbb R^{m},\;c\in\mathbb R^{n},
              \]
              e il suo <em>duale</em>:
              \[
                 (D)\; \max\;b^{\mathsf T}y\quad\text{s.t. }A^{\mathsf T}y \le c,\;y\ge0.
              \]
              Se \(x\) è ammissibile per \((P)\) e \(y\) è ammissibile per \((D)\) valgono
              le <strong>condizioni di complementarità (o di <span lang="en">complementary&nbsp;slackness</span>)</strong>:
              \[
                  \boxed{\;
                  \begin{aligned}
                    &x_j\bigl(c-A^{\mathsf T}y\bigr)_j = 0 &&\forall j=1,\dots,n,\\
                    &y_i\bigl(b-Ax\bigr)_i           = 0 &&\forall i=1,\dots,m .
                  \end{aligned}}\;
              \]
              Esse implicano che ogni variabile <span class="fst-italic">diversa da zero</span>
              nel primale forza la corrispondente disuguaglianza del duale all’uguaglianza
              (e vice‑versa).  Il <em>corollario di ottimalità</em> stabilisce che, qualora
              \(x\) e \(y\) siano ammissibili e soddisfino le condizioni di
              complementarità, allora sono entrambi <strong>soluzioni ottime</strong> con
              lo stesso valore obiettivo \(c^{\mathsf T}x=b^{\mathsf T}y\).

             
              L’approccio è puramente algebrico: non usa il Simplesso, ma il
              suo dizionario equivalente.
            </p>
          </div>
        </div>

        <!-- numero constraints -->
        <div class="mb-3">
          <label for="dimensionSelect" class="form-label fw-semibold">Numero di vincoli (righe):</label>
          <select id="dimensionSelect" class="form-select form-select-sm w-auto" onchange="updateFields()">
            <option value="2">2 vincoli</option>
            <option value="3" selected>3 vincoli</option>
            <option value="4">4 vincoli</option>
          </select>
        </div>

        <!-- function max/min -->
        <div class="mb-3">
          <label for="tipoFunzione" class="form-label fw-semibold">Tipo di problema:</label>
          <select id="tipoFunzione" class="form-select form-select-sm w-auto" onchange="updateFields()">
            <option value="max" selected>Massimizzazione</option>
            <option value="min">Minimizzazione</option>
          </select>
        </div>

        <!-- problema field -->
        <div class="mb-3">
          <label for="ccField" class="form-label fw-semibold">Inserisci il problema:</label>
          <math-field id="ccField" delete-mode="off" read-only="partial" class="math-input" style="font-size:22px;"></math-field>
          <div class="form-text small">
            Utilizza le variabili \(x_1, x_2, \dots\). Nella <em>ultima&nbsp;riga</em> devono comparire tutti i vincoli di non‑negatività richiesti dal problema, ad esempio \(x_{1}\ge 0,\,x_{2}\ge 0\).
          </div>
        </div>

        <!-- selettore solution primale / duale -->
        <div class="mb-3">
          <label for="tipoSol" class="form-label fw-semibold">La soluzione fornita è relativa a:</label>
          <select id="tipoSol" class="form-select form-select-sm w-auto">
            <option value="primale" selected>Primale</option>
            <option value="duale">Duale</option>
          </select>
        </div>

        <!-- tuple field -->
        <div class="mb-3">
          <label for="solField" class="form-label fw-semibold">Soluzione proposta:</label>
          <math-field id="solField" delete-mode="off" read-only="partial" class="math-input" style="font-size:22px;"></math-field>
          <div class="form-text small">
            Questa scheda analizza un problema lineare (primale o duale) in forma compatta, verifica l’ammissibilità di una soluzione proposta, costruisce le condizioni di complementarità e determina se essa è ottima.
          </div>
        </div>

        <!-- buttons -->
        <div class="text-center mt-3">
          <button id="solveButton" class="btn btn-primary btn-sm px-3" onclick="computeCC()">
            <i class="fas fa-play me-2"></i>Verifica
          </button>
          <button class="btn btn-secondary btn-sm px-3 ms-1" onclick="resetAll()">
            <i class="fas fa-eraser me-2"></i>Pulisci
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- OUTPUT -->
  <div class="col-12">
    <div class="card output-card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Output</h5>
      </div>
      <div class="card-body" id="output">
        <div class="empty-state text-center text-muted py-5">
          <i class="fas fa-calculator fa-3x mb-3 opacity-50"></i>
          <h6>Pronto per verificare</h6>
          <p class="small">Imposta il problema, inserisci la soluzione e premi "Verifica".</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function tupleLatex(k, tipoSol){
  const ph = [];
  for(let i=1;i<=k;i++){ ph.push(`\\placeholder[t${i}]{}`); }
  const tpl = '\\bigr( ' + ph.join(',\\,') + ' \\bigr)';
  const prefix = (tipoSol==='duale') ? 'y =' : 'x =';
  return prefix + ' ' + tpl;
}

function buildProblemLatex(n, tipo) {
  // goal row (min/max)
  const goal = (tipo === 'min' ? '\\min' : '\\max') + ' z = \\placeholder[obj]{} :';

  // constraint placeholders
  const rows = [];
  for (let i = 1; i <= n; i++) {
    rows.push(`\\placeholder[r${i}]{}`
    );                                             // generic constraints
  }

  /* ultima row: condizioni di non‑negatività, inserite in un unico
     placeholder (l’utente può modificarle a piacere).  Per comodità
     pre‑compiliamo il placeholder con “x_1 ≥ 0, x_2 ≥ 0, …, x_n ≥ 0”. */
  const nnRow = Array.from({ length: n }, (_, k) => `x_{${k + 1}} \\ge 0`).join(',\\, ');
  rows.push(`\\placeholder[nn]{${nnRow}}`);

  return '\\begin{aligned}' + [goal, ...rows].join('\\\\') + '\\end{aligned}';
}

function updateFields(){
  const n=parseInt(document.getElementById('dimensionSelect').value,10);
  const tipo=document.getElementById('tipoFunzione').value;
  const tipoSol = document.getElementById('tipoSol').value;
  ccField.setValue(buildProblemLatex(n,tipo));
  solField.setValue(tupleLatex(n, tipoSol));
}

document.getElementById('dimensionSelect').addEventListener('change', updateFields);
document.getElementById('tipoFunzione').addEventListener('change', updateFields);
document.getElementById('tipoSol').addEventListener('change', updateFields);

/* ---- extract constraints + non‑negativity -------------------------- */
function readProblem(n){
  const rows = [];
  for(let i=1;i<=n;i++){
    const raw = ccField.getPromptValue('r'+i)?.trim();
    if(!raw) return null;                        // missing row
    let sign, parts;
    if(raw.includes('>=')){ sign='>='; parts=raw.split('>='); }
    else if(raw.includes('\\ge')){ sign='>='; parts=raw.split('\\ge'); }
    else if(raw.includes('<=')){
      sign='<=';
      parts=raw.split('<=');
    }
    else if(raw.includes('\\le')){
      sign='<=';
      parts=raw.split('\\le');
    }
    else if (raw.includes('=') &&
             !raw.includes('<=') && !raw.includes('>=') &&
             !raw.includes('\\le') && !raw.includes('\\ge')) {
      sign = '=';
      parts = raw.split('=');
    }
    else { return null; }                       // sign not found
    if(parts.length!==2) return null;
    rows.push([parts[0].trim(), parts[1].trim(), sign]);
  }
  const nn = ccField.getPromptValue('nn')?.trim() || '';
  return { constraints: rows, nonneg: nn };
}

function resetAll(){updateFields();
  document.getElementById('output').innerHTML=`<div class="empty-state text-center text-muted py-5">
  <i class="fas fa-calculator fa-3x mb-3 opacity-50"></i>
  <h6>Pronto per verificare</h6><p class="small">Imposta il problema, inserisci la soluzione e premi "Verifica".</p></div>`;
}

document.addEventListener('DOMContentLoaded',()=>{
  window.ccField=document.getElementById('ccField');
  window.solField=document.getElementById('solField');
  updateFields();

  const cCollapse=document.getElementById('descrizioneCC');
  const dText=document.getElementById('descrizioneText');
  const dIcon=document.getElementById('descrizioneIcon');
  cCollapse.addEventListener('hide.bs.collapse',()=>{dText.textContent='Mostra descrizione';dIcon.classList.toggle('fa-chevron-up',false);dIcon.classList.toggle('fa-chevron-down',true);});
  cCollapse.addEventListener('show.bs.collapse',()=>{dText.textContent='Nascondi descrizione';dIcon.classList.toggle('fa-chevron-down',false);dIcon.classList.toggle('fa-chevron-up',true);});

  document.getElementById('tipoSol').addEventListener('change', updateFields);
});

/* semplice POST */
function computeCC(){
  const n = parseInt(document.getElementById('dimensionSelect').value, 10);
  const tipo = document.getElementById('tipoFunzione').value;
  const tipoSol = document.getElementById('tipoSol').value;
  const output = document.getElementById('output');
  const prob = readProblem(n);
  // read each placeholder value for the proposed solution tuple
  const solArr = [];
  for (let i = 1; i <= n; i++) {
    let rawVal = solField.getPromptValue(`t${i}`);
    if (!rawVal?.trim()) {
      output.innerHTML = '<div class="alert alert-danger">Compila tutte le componenti della soluzione proposta.</div>';
      MathJax.typesetPromise([output]);
      const btn = document.getElementById('solveButton');
      const originalHTML = btn.innerHTML;
      btn.disabled = false;
      btn.innerHTML = originalHTML;
      return;
    }
    let val = rawVal.trim();
    // Normalize LaTeX fractions (both {n}/{d} and nd) into "n/d"
    val = val
      .replace(/\\d?frac\{?(-?\d+)\}?\{?(-?\d+)\}?/g, '$1/$2')
      .replace(/\s+/g, '');  // strip any leftover whitespace
    solArr.push(val);
  }
  // build solution string as required for API
  const solStr = (tipoSol === 'duale' ? 'y' : 'x') + '=(' + solArr.join(',') + ')';
  const objStr = ccField.getPromptValue('obj')?.trim();

  if (!prob || !objStr) {
    output.innerHTML = '<div class="alert alert-danger">Compila tutti i campi del problema e la soluzione.</div>';
    MathJax.typesetPromise([output]);
    return;
  }
  const btn = document.getElementById('solveButton');
  const originalHTML = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analisi...';
  output.innerHTML = '<div class="text-center my-3"><div class="spinner-border text-primary"></div></div>';
  fetch('/api/complementary-conditions', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      tipo,
      n,
      modo: tipoSol,
      obj: objStr,
      constraints: prob.constraints,
      nonneg: prob.nonneg,
      sol: solStr
    })
  })
    .then(r => r.json()).then(res => {
      btn.disabled = false; btn.innerHTML = originalHTML;
      if (!res.success) { output.innerHTML = `<div class="alert alert-danger">${res.error}</div>`; }
      else {
        let latex = ''; const cont = document.createElement('div');
        res.steps.forEach((s, i) => {
          cont.insertAdjacentHTML('beforeend', `<p class="step-title"><b>${i})</b> ${s.title || ''}</p><p class="centered-math">\\[${s.content}\\]</p>`);
          latex += `${i}) ${s.title || ''}\n\\[${s.content}\\]\n`;
        });
        // --- "Add to notebook" ----------------------
        const saveDiv = document.createElement('div');
        saveDiv.id = 'ccNotebookButton';
        saveDiv.classList.add('mt-3');
        cont.appendChild(saveDiv);

        if (typeof window.injectSaveButton === 'function') {
          const payload = {
            title: 'Condizioni di Complementarità',
            algorithm: 'Verifica condizioni di complementarità',
            input: JSON.stringify({ tipo, n, problema: prob, soluzione: solStr }),
            htmlOutput: cont.outerHTML,
            outputLatex: latex,
            rawData: res
          };
          window.injectSaveButton(saveDiv, payload);
        }
        const wrap = document.createElement('div'); wrap.className = 'result-section'; wrap.appendChild(cont);
        output.innerHTML = ''; output.appendChild(wrap); MathJax.typesetPromise([output]);
      }
    }).catch(e => { btn.disabled = false; btn.innerHTML = originalHTML; output.innerHTML = `<div class="alert alert-danger">${e.message}</div>`; });
}
</script>
{% endblock %}
